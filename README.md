# FPGAOL v1.1 使用说明

[FPGAOL](http://202.38.79.134)是一个线上硬件实验平台，通过将FPGA放在云上，实现硬件资源的高效利用，并力图为学生提供与实际的FPGA相同甚至更好的使用体验。

FPGAOL v1.1是FPGAOL的最近一次更新。在本次更新中，我们增加了一些管脚并重点优化了数码管显示和波形图生成的功能。

## 开关与LED

<img src="img/ledsw.png" alt="Screen Shot 2020-04-23 at 8.51.58 AM" width="300" />

FPGAOL v1.1的开关与LED部分与FPGAOL v1.0相比没有变化，管脚的对应关系为：

|  SW  |  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| 管脚 | D14  | F16  | G16  | H14  | E16  | F13  | G13  | H16  |

| LED  |  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| 管脚 | C17  | D18  | E18  | G17  | D17  | E17  | F18  | G18  |

为了避免上一版本中因频繁刷新LED导致页面卡死的情况，本版本的LED刷新间隔为**0.1 s**，快于该频率的LED变化将无法正常显示。

### 示例程序

LED和SW部分的[示例程序](./ledsw)直接将开关与LED相连，开关的变化将直接体现在LED上。

## 七段数码管🔢

<img src="img/7seg.png" alt="Screen Shot 2020-04-23 at 8.52.29 AM" width="600" />

数码管分为hex_play和seg_play两部分，实验时我们主要用到的是hex_play。

### hex_play

七段数码管是本次更新中改进较大的部分。FPGAOL v1.1拥有了8个七段数码管，并且引入了更贴近实际的显示方式。

由于FPGAOL上的管脚数量有限，我们对数码管进行了一定的**简化**：在使能方面，不再通过8个管脚分别使能8个数位，而是使能`AN[3:0]`所表示的二进制数所对应的数位，例如若`AN = 3'b010`，则下标为2的数位被使能；在显示的数字方面，不再通过`SEG`信号独立控制每个段（segment），而是直接显示`D[3:0]`形成的16进制数。

除此之外，数码管的使用方式与正常情况下无异。和现实中的数码管一样，我们建议的扫描频率为**50Hz**，但请注意对”扫描频率“的理解，它指的是在一秒内，每个数位都应当被扫描50次，也就是说，为了扫描8位数码管，我们需要一个50*8=400Hz的时钟来驱动，而不是50Hz。

数码管与FPGA上管脚的对应关系为：

|  D0  |  D1  |  D2  |  D3  | AN0  | AN1  | AN2  |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| A14  | A13  | A16  | A15  | B17  | B16  | F18  |

再此简要说明七段数码管的显示方式。现实中的七段数码管是通过快速的扫描，利用人眼的视觉延迟来实现在不同的数位上显示不同的数字的，但在网页上，这显然不可能。于是在新版本的FPGAOL中，我们先对采集到的数码管控制信号进行预处理，按照七段数码管的显示原理计算出每个数位上显示的数字，并直接在网页上显示。

具体来讲，确定数码管每一位所显示数字的算法大致为：

```
while true:
	sleep(0.1)    // 每隔0.1秒刷新一次
	for i=0 to 7:
		for j=0 to 15:
			T[i][j] = 过去0.1秒内，AN为i且D为j的总时长
		max_j, max_t = max(T[i][j])
		display `max_j` on `i`
```

### seg_play

为了弥补hex_play不能按段来显示数字的缺陷，我们提供了seg_play，它是支持通过段来控制的一位数码管。为了节约管脚，它的控制信号是与LED共享的，可以通过LED的信号来控制它，具体的对应关系如下：

<img src="img/segplay.png" alt="Screen Shot 2020-04-23 at 8.58.59 AM" width="150" />

| 数码管 |  A   |  B   |  C   |  D   |  E   |  F   |  G   | 小数点 |
| :----: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :----: |
|  LED   |  0   |  1   |  2   |  3   |  4   |  5   |  6   |   7    |

### 示例程序

七段数码管的[示例程序](./seg)是一个以秒为单位的16进制计时器，当SW0为0时该计时器递增，反之则递减。

## UART

该功能还没做完，待补充。

### 示例程序

TBA

## 软时钟与按钮🔘

<img src="img/button.png" alt="Screen Shot 2020-04-23 at 8.52.40 AM" width="300" />

FPGAOL计划提供一个速度比较慢的由软件驱动的时钟，以免去同学们给FPGA板载时钟降频的麻烦，但本版本的FPGAOL并没有提供该功能。

本版本的FPGAOL提供了一个按钮，该按钮**按下时为高电平，松开时为低电平**，按钮所对应的管脚如下：

| 按钮序号 |  0   |
| :------: | :--: |
|   管脚   | A18  |

## 生成波形图

<img src="img/wf_btn.png" width="250" />

在FPGAOL v1.0中，我们提供了一个实时刷新的波形图，但它的显示效果一般，最终成为了一个鸡肋的功能。在新版本中，我们去掉了这个实时波形图，转而将对FPGA的采样结果直接存储为**vcd**格式的波形文件，可以通过[GTKWave](http://gtkwave.sourceforge.net)等软件打开，遗憾的是vivado没有提供查看vcd文件的功能。

<img src="img/wf.png" alt="Screen Shot 2020-04-23 at 9.38.56 AM" width="600" />

目前，该波形图的采样间隔为**5 us**，希望它能为同学们**调试程序**、助教**远程检查实验**等提供便利。本文作者在前不久就通过该波形图锁定了我们的测试比特流中存在的bug，所以我认为如果使用得当，这有可能成为FPGAOL的一个*killer feature*。

## Help Needed!

尽管我们一直努力地完善FPGAOL的功能，但目前仍有很多不尽如人意的地方。如果你对这个平台如何工作很感兴趣，或是有好的点子，或是想让学弟学妹不再为玄学的硬件实验而发愁，欢迎联系我们，和我们一起改进这个平台！

